<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - Manage Products</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 800px;
    }
    form {
      margin-bottom: 30px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 5px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      box-sizing: border-box;
    }
    button {
      margin-top: 15px;
      padding: 8px 12px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
    .action-btn {
      margin-right: 5px;
      padding: 4px 8px;
    }
  </style>
</head>
<body>
  <h1>Admin Panel - Manage Products</h1>

  <form id="product-form">
    <input type="hidden" id="product-id" />

    <label for="name">Product Name:</label>
    <input type="text" id="name" required />

    <label for="price">Price (USD):</label>
    <input type="number" id="price" min="0" step="0.01" required />

    <label for="images">Image Filenames (comma separated):</label>
    <input type="text" id="images" placeholder="e.g. shirt1.webp, shirt2.webp" required />

    <label>Sizes (select one or more):</label>
    <label><input type="checkbox" name="size" value="XS" /> XS</label>
    <label><input type="checkbox" name="size" value="S" /> S</label>
    <label><input type="checkbox" name="size" value="M" /> M</label>
    <label><input type="checkbox" name="size" value="L" /> L</label>
    <label><input type="checkbox" name="size" value="XL" /> XL</label>

    <label for="gender">Gender:</label>
    <select id="gender" required>
      <option value="">Select Gender</option>
      <option value="Men">Men</option>
      <option value="Women">Women</option>
      <option value="Unisex">Unisex</option>
      <option value="Kids">Kids</option>
    </select>

    <button type="submit">Save Product</button>
    <button type="button" id="cancel-edit" style="display:none; margin-left:10px;">Cancel Edit</button>
  </form>

  <h2>Existing Products</h2>
  <table id="products-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Price</th>
        <th>Images</th>
        <th>Sizes</th>
        <th>Gender</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Products will be listed here -->
    </tbody>
  </table>

  <script>
    const form = document.getElementById('product-form');
    const productIdInput = document.getElementById('product-id');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const productsTableBody = document.querySelector('#products-table tbody');

    // Load and render products in the table
    async function loadProducts() {
      const res = await fetch('/api/products');
      const products = await res.json();

      productsTableBody.innerHTML = '';
      products.forEach(product => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${product.id}</td>
          <td>${product.name}</td>
          <td>$${product.price.toFixed(2)}</td>
          <td>${product.images.join(', ')}</td>
          <td>${product.sizes.join(', ')}</td>
          <td>${product.gender}</td>
          <td>
            <button class="action-btn" onclick="editProduct(${product.id})">Edit</button>
            <button class="action-btn" onclick="deleteProduct(${product.id})">Delete</button>
          </td>
        `;
        productsTableBody.appendChild(tr);
      });
    }

    // Fill the form with product data for editing
    async function editProduct(id) {
      const res = await fetch('/api/products');
      const products = await res.json();
      const product = products.find(p => p.id === id);
      if (!product) return alert('Product not found');

      productIdInput.value = product.id;
      form.name.value = product.name;
      form.price.value = product.price;
      form.images.value = product.images.join(', ');
      
      // Set sizes checkboxes
      document.querySelectorAll('input[name="size"]').forEach(checkbox => {
        checkbox.checked = product.sizes.includes(checkbox.value);
      });

      form.gender.value = product.gender;

      cancelEditBtn.style.display = 'inline-block';
      form.querySelector('button[type="submit"]').textContent = 'Update Product';
    }

    // Cancel editing mode
    cancelEditBtn.addEventListener('click', () => {
      resetForm();
    });

    // Delete a product by ID
    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
      if (res.ok) {
        alert('Product deleted');
        loadProducts();
        resetForm();
      } else {
        alert('Failed to delete product');
      }
    }

    // Reset the form to add state
    function resetForm() {
      productIdInput.value = '';
      form.reset();
      cancelEditBtn.style.display = 'none';
      form.querySelector('button[type="submit"]').textContent = 'Save Product';
      // Uncheck sizes
      document.querySelectorAll('input[name="size"]').forEach(cb => cb.checked = false);
    }

    // Handle form submission
    form.addEventListener('submit', async e => {
      e.preventDefault();

      const name = form.name.value.trim();
      const price = parseFloat(form.price.value);
      const images = form.images.value.split(',').map(img => img.trim()).filter(Boolean);
      const sizes = Array.from(document.querySelectorAll('input[name="size"]:checked')).map(cb => cb.value);
      const gender = form.gender.value;

      if (!name || isNaN(price) || images.length === 0 || sizes.length === 0 || !gender) {
        return alert('Please fill all fields correctly.');
      }

      const productData = { name, price, images, sizes, gender };

      try {
        let res;
        if (productIdInput.value) {
          // Update existing product
          res = await fetch(`/api/products/${productIdInput.value}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(productData)
          });
        } else {
          // Add new product
          res = await fetch('/api/products', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(productData)
          });
        }

        if (!res.ok) {
          const errorData = await res.json();
          alert('Error: ' + errorData.error);
          return;
        }

        alert(productIdInput.value ? 'Product updated!' : 'Product added!');
        resetForm();
        loadProducts();
      } catch (error) {
        alert('Failed to save product: ' + error.message);
      }
    });

    // Initial load
    loadProducts();
  </script>
</body>
</html>
